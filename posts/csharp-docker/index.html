<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Docker for the C# developers Crash Course - aiki.dev</title>
  <meta name="description" content="What are we going to learn? The goal is to help you achieve practical, working knowledge of Docker so you can build containerized micro-services in C# with relative ease. We are going to use .Net core as it is cross-platform and well supported on Linux-based Docker containers. Having said that, the Windows-based Docker containers exist too, but the haven&rsquo;t got much traction.
Source code The source code is available on github">
  <meta name="author" content="Lech Gudalewicz"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "aiki.dev",
    
    "url": "https:\/\/aiki.dev\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/aiki.dev\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/aiki.dev\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/aiki.dev\/posts\/csharp-docker\/",
          "name": "Docker for the c# developers crash course"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Lech Gudalewicz"
  },
  "headline": "Docker for the C# developers Crash Course",
  "description" : "What are we going to learn? The goal is to help you achieve practical, working knowledge of Docker so you can build containerized micro-services in C# with relative ease. We are going to use .Net core as it is cross-platform and well supported on Linux-based Docker containers. Having said that, the Windows-based Docker containers exist too, but the haven\u0026rsquo;t got much traction.\nSource code The source code is available on github",
  "inLanguage" : "en",
  "wordCount":  2547 ,
  "datePublished" : "2020-06-15T14:48:13",
  "dateModified" : "2020-06-15T14:48:13",
  "image" : "https:\/\/aiki.dev\/images\/logo.png",
  "keywords" : [ "C#, Docker" ],
  "mainEntityOfPage" : "https:\/\/aiki.dev\/posts\/csharp-docker\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/aiki.dev\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/aiki.dev\/images\/logo.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Docker for the C# developers Crash Course" />
<meta property="og:description" content="What are we going to learn? The goal is to help you achieve practical, working knowledge of Docker so you can build containerized micro-services in C# with relative ease. We are going to use .Net core as it is cross-platform and well supported on Linux-based Docker containers. Having said that, the Windows-based Docker containers exist too, but the haven&rsquo;t got much traction.
Source code The source code is available on github">
<meta property="og:image" content="https://aiki.dev/images/logo.png" />
<meta property="og:url" content="https://aiki.dev/posts/csharp-docker/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="aiki.dev" />

  <meta name="twitter:title" content="Docker for the C# developers Crash Course" />
  <meta name="twitter:description" content="What are we going to learn? The goal is to help you achieve practical, working knowledge of Docker so you can build containerized micro-services in C# with relative ease. We are going to use .Net core â€¦">
  <meta name="twitter:image" content="https://aiki.dev/images/logo.png" />
  <meta name="twitter:card" content="summary" />
  <link href='https://aiki.dev/images/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.78.2" />
  <link rel="alternate" href="https://aiki.dev/index.xml" type="application/rss+xml" title="aiki.dev"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://aiki.dev/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://aiki.dev/css/highlight.min.css" /><link rel="stylesheet" href="https://aiki.dev/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-159944114-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://aiki.dev/">aiki.dev</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Series" href="/series">Series</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="aiki.dev" href="https://aiki.dev/">
            <img class="avatar-img" src="https://aiki.dev/images/logo.png" alt="aiki.dev" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="posts-heading">
              
                <h1>Docker for the C# developers Crash Course</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <h2 id="what-are-we-going-to-learn">What are we going to learn?</h2>
<p>The goal is to help you achieve practical, working knowledge of Docker so you can build containerized micro-services in C# with relative ease. We are going to use .Net core as it is cross-platform and well supported on Linux-based Docker containers. Having said that, the Windows-based Docker containers exist too, but the haven&rsquo;t got much traction.</p>
<h4 id="source-code">Source code</h4>
<p>The source code is available on <a href="https://github.com/lechgu/docker_csharp">github</a></p>
<h2 id="what-tools-do-i-need">What tools do I need?</h2>
<p>Ironically, Windows is not an absolute prerequisite for this exercise. One can build C#-powered containerized micro-services on Mac or Linux too.
Windows will work too, of course.</p>
<ul>
<li>First, you need <a href="https://www.docker.com/">Docker</a> installed. Follow the link and install <code>Docker desktop</code> for your system.</li>
<li>Second, you need the <a href="https://dotnet.microsoft.com">.Net core SDK</a>. Install the latest version of .Net core SDK, which is 3.1 at the time of writing.</li>
<li>You need a text editor. If you are not settled, consider <a href="https://code.visualstudio.com/">Visual Studio Code</a> It is cross-platform, fast and it works great with C# and Docker.</li>
<li>Many of the activities will be command-line based. Use the shell available to you. To keep things as cross-platform as possible, I am going to use Git Bash on Windows. If you don&rsquo;t know, Visual Studio Code has great support for working with the command line.</li>
</ul>
<h4 id="sanity-check">Sanity check</h4>
<p>In the command line run</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker --version
</code></pre></div><p>and</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">dotnet --version
</code></pre></div><p>If you get some sane answer in both cases, you are all set.</p>
<h2 id="your-first-encounter-with-docker">Your first encounter with Docker</h2>
<p>Run</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker run alpine date
</code></pre></div><p>You should see current time displayed in the shell</p>
<h4 id="what-just-happened">What just happened?</h4>
<p>by running this command you instructed docker to start a container based on the <code>alpine</code> image, execute the command <code>date</code> and display its output in the shell. If you did not have the <code>alpine</code> image on your box (most likely), docker downloaded it from the <a href="https://hub.docker.com/">Dockerhub</a>, the public repository of well known Docker images.</p>
<h4 id="containers-images-i-am-confused">Containers, images&hellip; I am confused.</h4>
<p>You can think about it this way: if an Image is analogous to an &lsquo;.exe&rsquo; file, container is the process which runs once you start this .exe file.</p>
<h4 id="ok-what-is-this-alpine-thing-anyway">Ok, what is this alpine thing, anyway?</h4>
<p><a href="https://alpinelinux.org/">Alpine</a> is a Linux distribution which is quite popular in the Docker community, because it is very minimalistic and small.</p>
<h4 id="your-turn">Your turn</h4>
<p>instead of the <code>date</code> try to run other commands. <code>pwd</code>, <code>whoami</code> are good examples</p>
<h2 id="explore-the-alpine-container">Explore the Alpine container</h2>
<p>This time start the container with the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker run -it alpine sh
</code></pre></div><p>the <code>it</code> flag indicates to start the container in the <em>interactive</em> mode and run <code>sh</code> command which is Alpine&rsquo;s default shell. You will end up inside the container. Look around, explore what is there using <code>ls</code> and and <code>cd</code> commands. <code>cat</code> will display the content of the text file, for example</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">cat /etc/hosts
</code></pre></div><p>If you are familiar with the <code>vi</code> editor you can create or edit some files too.
By default, alpine does not have any fancy tools to access Internet.
This can be mitigated:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">apk add curl
</code></pre></div><p><code>apk</code> is Alpine&rsquo;s package installer, you can install various apps with it. Now, try to do</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">curl http://www.microsoft.com
</code></pre></div><p>You should get the Microsoft&rsquo;s home page, in the text format, of course.</p>
<p>When you done exploring, exit the container:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">exit
</code></pre></div><p>You should get back to your normal shell</p>
<h4 id="your-turn-1">Your turn</h4>
<p>The Alpine image is supposed to be small, But how small is it, exactly? Hint: <code>docker images</code> gives the list of images available on your system.</p>
<h2 id="c-console-application">C# console application</h2>
<p>Now we are going to replicate the experience we had running <code>date</code> in the docker container, but this time with a C# app.
Let&rsquo;s create the app:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">mkdir date
cd date
dotnet new console
</code></pre></div><p>This scaffolds a simple .net core command line application.
Go to the <code>Program.cs</code> and replace the line</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Console.WriteLine(&#34;Hello World!&#34;);
</code></pre></div><p>with</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Console.WriteLine(DateTime.UtcNow);
</code></pre></div><h4 id="sanity-check-1">Sanity check</h4>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">dotnet run
</code></pre></div><p>This should display the current UTC time.</p>
<h2 id="dockerize-c-command-line-application">Dockerize C# command line application</h2>
<p>Now, let&rsquo;s put our application to the Docker image. For that, we&rsquo;ll need a <code>Dockerfile</code>. <code>Dockerfile</code> is essentially a list of instructions which Docker is supposed to follow in order to build your image.
create a file Dockerfile` and put the following line into it:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">FROM mcr.microsoft.com/dotnet/core/sdk:3.1-alpine
</code></pre></div><p>This instructs Docker to build our image on top of predefined Alpine-based image but which has .net core sdk 3.1 installed
Docker images are layered, every new layer adds additional functionality. We could have start from the bare Alpine image and install the .net core sdk ourselves, that is pretty straightforward but quite tedious. So we&rsquo;ll start with the base image Microsoft provides us.
Now we can try to build the image</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker build -t csharpdate .
</code></pre></div><p>the <code>-t</code> parameter specifies the name of the image, which is going to be <code>csharpdate</code> in this case. The argument <code>.</code>(dot) instructs Docker where to look for the <code>Dockerfile</code>, which is the current directory in our case.
After few seconds the image is going to be buit. As mentioned before, it is layered and has Alpine underneath, so we can explore it as we did before:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker run -it csharpdate sh
</code></pre></div><p>We end up in the familiar Alpine shell. But this time it has also .net core tools installed, for instance, you can run <code>dotnet</code>.</p>
<p>Anyway, the next task is to copy the sources into the docker image and build them
Append the following lines to the <code>Dockerfile</code></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">WORKDIR /app
COPY date.csproj Program.cs ./
</code></pre></div><p>The <code>WORKDIR</code> directive specifies what is the <em>current directory</em> in the Docker image, <code>/app</code> in our case. It will be created if needed.
The COPY directive instructs Docker to copy our C# source file and associated <code>.csproject</code> file into the image&rsquo;s <em>current directory</em>
After that you will have everything you need to build the final binary in image.</p>
<h4 id="your-turn-2">Your turn</h4>
<p>Rebuild the image, launch the container and verify that the files are indeed there. Also verify that the current directory is <code>/app</code>.</p>
<p>The last step is to actually build the application.
Append to the <code>Dockerfile</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">RUN dotnet publish -c Release -o build --self-contained=false
</code></pre></div><p>This builds the C# project in the release mode and places the output in the <code>build</code> subdirectory of the current directory, that is into <code>/app/build</code></p>
<p>Once the image is rebuilt we can launch our program inside the container:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker run csharpdate dotnet /app/build/bin/date.dll
</code></pre></div><p>this will print again the current UTC time, but this time coming from our C# program!</p>
<p>Specifying the full path to the binary we want to run every time is quite tedious. Docker has a directive which allows to designate some command line as the default.
Append to your <code>DOCKERFILE</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">CMD [ &#34;dotnet&#34;, &#34;/app/build/date.dll&#34; ]
</code></pre></div><p>Rebuild the image and now you can launch the binary simply running:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">dotnet run csharpdate
</code></pre></div><h4 id="your-turn-3">Your turn</h4>
<p>Experiment: Try to modify the code in the <code>Program.cs</code>, try to specify different build flags and so on</p>
<h2 id="c-microservice">C# microservice</h2>
<p>Ok, containerizing a command line application is cool, but it does not look like a microservice, does it?
In this part we are going to create a simple service which returns the current UTC time from the REST endpoint.
We are going to use Asp.Net Core for that. But don&rsquo;t be scared! We are not going to use most of the Asp.Net Core machinery to get our service working. The secret is that, in fact, self-hosted Asp.Net Core applications are, in fact, command line applications!
So let&rsquo;s create a directory <code>datems</code> at the same level as the <code>date</code> directory and initialize a .Net Core command line application there:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">dotnet new console
</code></pre></div><p>We will need to bring Asp.Net Core -specific dependencies into the project. This is hush-hush, but the simplest way to do int is to open the <code>datems.csproj</code> and replace the line</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&lt;Project Sdk=&#34;Microsoft.NET.Sdk&#34;&gt;
</code></pre></div><p>with</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&lt;Project Sdk=&#34;Microsoft.NET.Sdk.Web&#34;&gt;
</code></pre></div><p>Don&rsquo;t tell anyone, let them suffer through the official tutorials.</p>
<p>If we run the project</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">dotnet run

</code></pre></div><p>it will still happily run and display the ubiquitous &ldquo;Hello World!&rdquo;.</p>
<p>Asp.Net Core is actually a pretty cool and rich framework; if you build Web apps or Rest services on a daily basis, I encourage to study it deeper. But we will use a bare minimum of its features to get our microservice working. So don&rsquo;t expect best Asp.Net practices here.</p>
<p>We&rsquo;ll need to use some namespaces. Here is the full list, feel free to add these into the <code>Program.cs</code></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">using System;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
</code></pre></div><p>To start a Asp.Net Core app we need to:</p>
<ul>
<li>create an instance of <code>IHostBuilder</code></li>
<li>ask it to <em>Build</em> that host</li>
<li>finally to run it.</li>
</ul>
<p>We are going to do all these steps in our Main method:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"> static void Main(string[] args)
    {
        var builder = Host.CreateDefaultBuilder(args).ConfigureWebHostDefaults(webBuilder =&gt;
        {
            webBuilder
                .UseUrls(&#34;http://0.0.0.0:5000&#34;)
                .UseStartup&lt;Program&gt;();
        });

        builder.Build().Run();
    }
</code></pre></div><p>There is some Asp.Net Core magic here. Feel free to explore that on your own. For example, we indicate that we are going to listen on all network interfaces on port 5000.
The key here is the <code>webBuilder.UseStartup&lt;Program&gt;</code> call.
This indicates that our <code>Program</code> class defines the Asp.Net Core <em>pipeline</em>.</p>
<p>In order satisfy this Asp.Net Core requirement, we need to implement two methods, <code>ConfigureServices</code> and <code>Configure</code>
The simple ConfigureServices looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public void ConfigureServices(IServiceCollection services)
{
    services.AddControllers();
}
</code></pre></div><p>In here we tell that we want to use AspNet Core Controllers which are going to serve as our REST endpoints.
the <code>Configure</code> looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    app.UseRouting();

    app.UseEndpoints(endpoints =&gt;
    {
        endpoints.MapDefaultControllerRoute();
    });
}
</code></pre></div><p>We simply tell Asp.Net Core that we will need to <em>route</em> the requests depending on the URL, and that the default route is just fine.</p>
<h4 id="sanity-check-2">Sanity Check</h4>
<p>Run</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">dotnet run
</code></pre></div><p>If everything is ok, the app should start and listen for the Http request on the default port 5000
However, if we try to navigate in the browser to http://localhost:5000 we&rsquo;ll be greeted with tho &ldquo;not found&rdquo; error. What gives?</p>
<p>The answer is that we asked to wire up the default route which, by convention implies the &ldquo;Home&rdquo; controller with the &ldquo;Index&rdquo; action.</p>
<h2 id="the-controller">The controller</h2>
<p>Let&rsquo;s implement the required controller. Nothing fancy.
Create the class HomeController (you can use the same <code>Program.cs</code> file):</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public class HomeController : Controller
{
    public IActionResult Index()
    {
        return Ok(42);
    }
}
</code></pre></div><p>We are saying, return the http Ok response (200) with the payload &ldquo;42&rdquo;.</p>
<h4 id="another-sanity-check">Another sanity check</h4>
<p>Restart the app and navigate in the browser to http://localhost:5000
You should see the &ldquo;42&rdquo; showing up on the page.</p>
<h3 id="return-the-json-response">return the Json response</h3>
<p>The last step is to return an object formatted as JSON, instead of the answer to life, universe and everything.
Let&rsquo;s create a response class:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public class TimeResponse
{
    public DateTime Current { get { return DateTime.UtcNow; } }
}
</code></pre></div><p>and return that from the controller:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public IActionResult Index()
{
    return Ok(new TimeResponse());
}
</code></pre></div><p>Restart the app, refresh the browser and you should see the current time formatted as JSON.</p>
<p>Our &ldquo;real&rdquo; microservice is pretty much ready.</p>
<h2 id="build-docker-image-for-the-microservice">Build Docker image for the microservice</h2>
<p>Ironically our <code>Dockerfile</code> for the command line application should mostly work for the microservice, so you can just copy the <code>Dockerfile</code> from the <code>date</code> directory to the <code>datems</code> directory.
do the following tweaks in that <code>Dockefile</code>:</p>
<ul>
<li>correct the C# project file name from <code>date.csproj</code> to <code>datems.csproj</code></li>
<li>correct the app dll name in the <code>CMD</code> directive from <code>date.dll</code> to <code>datems.dll</code></li>
</ul>
<p>Build the new Docker image in the <code>datems</code> directory, this time calling the image <code>csharpms</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker build -t csharpms .
</code></pre></div><p>Let&rsquo;s start the container</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker run -d csharpms
</code></pre></div><p>The <code>-d</code> flag indicates to start the container in detached mode, so it detaches from the console</p>
<p>The Docker should start the container and print its id, a long hexadecimal number
let&rsquo;s dive into the running container.
Run</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker exec -it [container id] sh
</code></pre></div><p>Hint: you don&rsquo;t need to provide the full container id. A few of initial hexadecimal digits should be enough for the Docker to figure out which container you have in mind.
For example:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker exec -it 9e544440bd sh
</code></pre></div><p>Your id will be obviously different.
You should end up inside the running container!
check if your app is running:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">ps aux
</code></pre></div><p>You should see the something like</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">PID   USER     TIME  COMMAND
    1 root      0:00 dotnet /app/build/datems.dll
</code></pre></div><p>This shows that our service is running.
Try to see which ports are open:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">netstat -na
</code></pre></div><p>you should see the port 5000 is listening. This is our microservice!</p>
<h4 id="your-turn-4">Your turn</h4>
<p>Use curl inside the container to get the answer from the microservice.
Reminder, you can install curl in the Alpine based container by running</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">apk add curl
</code></pre></div><p>Well, the microservice seems to listen on port 5000, but how can we reach it, say from our box? Your machine has very different idea what is the port 5000 than the container.</p>
<h2 id="port-mapping">Port mapping</h2>
<p>Exit the container and stop it by executing</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker rm -f [container_id]
</code></pre></div><p>If you forgot what is the container id, you can list all running containers with</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker ps
</code></pre></div><p>Port mapping in Docker allows to attach a certain port on the machine to a specific port in the container. Let&rsquo;s say that we want the port 5000 in the container correspond to the port 9090 on your machine.
Start the container this way:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker run -d -p 9090:5000 csharpms
</code></pre></div><p>Now all tcp/ip traffic to and from port 9090 on our machine will actually end up in the port 5000 in the container</p>
<h4 id="sanity-check-3">Sanity check</h4>
<p>in the browser, navigate to http://localhost:9090. You should get your nice UTC time back.</p>
<h2 id="shrinking-image-size-with-multi-stage-builds">Shrinking image size with multi-stage builds</h2>
<p><code>docker images</code> will display all images we have on our box, together with their sizes.</p>
<p>If we check the size of the <code>csharpms</code> image it is quite big. On my machine it takes 422 MB. Large image cause higher resources' usage and slow downloads. Can we shrink our image? Sure we can! One of the most important reasons why the image is so bloated is that it contains whole .Net Core 3.1 SDK. Well, we need SDK to build our microservice binary, but we not necessary need it to run it. The leaner image might suffice.</p>
<p>Docker supports so called <em>multi-stage</em> builds when you copy specific files not from the host machine but from another Docker image, possibly unrelated to one we are building.
So here is the plan:</p>
<ul>
<li>In the first (or <em>build</em>) stage we will use the SDK image as before to build the binary.</li>
<li>The second (the <em>final</em>) will be based on a leaner baser image into which we will copy the binary produced by the <em>build</em> stage.
After the <em>final</em> stage is ready, the <em>build</em> stage will be effectively discarded</li>
</ul>
<p>Here is the resulting <code>Dockerfile</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">FROM mcr.microsoft.com/dotnet/core/sdk:3.1-alpine as build

WORKDIR /app
COPY datems.csproj Program.cs ./
RUN dotnet publish -c Release -o build --self-contained=false

FROM mcr.microsoft.com/dotnet/core/aspnet:3.1-alpine as final
RUN mkdir /app
COPY --from=build /app/build/* /app/

CMD [ &#34;dotnet&#34;, &#34;/app/datems.dll&#34; ]
</code></pre></div><p>Rebuild the image and check its size</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker build -t csharpms .
docker images | grep csharpms
</code></pre></div><p>On my machine it takes 105 MB, 4 time smaller then original. Not bad!</p>
<h4 id="sanity-check-4">Sanity check</h4>
<p>Start the container from the final image</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker run -d -p 9090:5000 csharpms
</code></pre></div><p>check with the browser or <code>curl</code> that it works as well as before.</p>
<h2 id="summary">Summary</h2>
<p>Our microservice is containerized and ready. Granted, this is a toy microservice with trivial functionality. But now you have skills to build a Docker image with the C# service as complex as you want.</p>


        
          <div class="blog-tags">
            
              <a href="https://aiki.dev//tags/c/">C#</a>&nbsp;
            
              <a href="https://aiki.dev//tags/docker/">Docker</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2faiki.dev%2fposts%2fcsharp-docker%2f&amp;text=Docker%20for%20the%20C%23%20developers%20Crash%20Course&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2faiki.dev%2fposts%2fcsharp-docker%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2faiki.dev%2fposts%2fcsharp-docker%2f&amp;title=Docker%20for%20the%20C%23%20developers%20Crash%20Course" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2faiki.dev%2fposts%2fcsharp-docker%2f&amp;title=Docker%20for%20the%20C%23%20developers%20Crash%20Course" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2faiki.dev%2fposts%2fcsharp-docker%2f&amp;title=Docker%20for%20the%20C%23%20developers%20Crash%20Course" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2faiki.dev%2fposts%2fcsharp-docker%2f&amp;description=Docker%20for%20the%20C%23%20developers%20Crash%20Course" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/posts/csharp-grpc-streaming/">No-nonsense gRPC guide for the C# developers, Part Three: Streaming</a></li>
                
                    <li><a href="/posts/csharp-grpc-secure/">No-nonsense gRPC guide for the C# developers, Part Two: Secure service</a></li>
                
                    <li><a href="/posts/csharp-grpc-basic/">No-nonsense gRPC guide for the C# developers, Part One: Basic Service</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://aiki.dev/posts/ship-it/" data-toggle="tooltip" data-placement="top" title="Pixies, part 12: Ship It!">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://aiki.dev/posts/micro-django/" data-toggle="tooltip" data-placement="top" title="Micro Django">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          
          <div class="disqus-comments">                  
            <button id="show-comments" class="btn btn-default" type="button">Show <span class="disqus-comment-count" data-disqus-url="https://aiki.dev/posts/csharp-docker">comments</span></button>
            <div id="disqus_thread"></div>

            <script type="text/javascript">
              var disqus_config = function () {
              this.page.url = 'https:\/\/aiki.dev\/posts\/csharp-docker';
            };

          </script>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/lechgu" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="aiki.dev">Lech Gudalewicz</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2020
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://aiki.dev/">aiki.dev</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.78.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://aiki.dev/js/main.js"></script>
<script src="https://aiki.dev/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://aiki.dev/js/load-photoswipe.js"></script>








<script type="text/javascript">
$(function(){
  $('#show-comments').on('click', function(){
    var disqus_shortname = 'aiki-dev';
      
    (function() {
      var disqus = document.createElement('script'); 
      disqus.type = 'text/javascript'; 
      disqus.async = true;
      disqus.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(disqus);
    })();
      
    $(this).hide(); 
    });
  });
      
</script>
<script id="dsq-count-scr" src="//aiki-dev.disqus.com/count.js" async></script>




    
  </body>
</html>

